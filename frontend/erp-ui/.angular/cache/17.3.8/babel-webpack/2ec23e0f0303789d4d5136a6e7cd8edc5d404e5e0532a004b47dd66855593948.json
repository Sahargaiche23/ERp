{"ast":null,"code":"import { BehaviorSubject, tap } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"./config.service\";\nexport let AuthService = /*#__PURE__*/(() => {\n  class AuthService {\n    http;\n    config;\n    apiUrl;\n    currentUserSubject = new BehaviorSubject(null);\n    currentUser$ = this.currentUserSubject.asObservable();\n    constructor(http, config) {\n      this.http = http;\n      this.config = config;\n      this.apiUrl = this.config.getAuthApiUrl();\n      const user = this.getUserFromStorage();\n      if (user) {\n        this.currentUserSubject.next(user);\n      }\n    }\n    register(request) {\n      return this.http.post(`${this.apiUrl}/register`, request);\n    }\n    login(credentials) {\n      return this.http.post(`${this.apiUrl}/login`, credentials).pipe(tap(response => {\n        if (response.accessToken) {\n          this.setSession(response);\n        }\n      }));\n    }\n    verifyOtp(request) {\n      return this.http.post(`${this.apiUrl}/verify-otp`, request).pipe(tap(response => {\n        if (response.accessToken && response.user) {\n          this.setSession(response);\n        }\n      }));\n    }\n    sendResetOtp(request) {\n      return this.http.post(`${this.apiUrl}/reset-password`, request);\n    }\n    verifyOtpAndResetPassword(request) {\n      return this.http.post(`${this.apiUrl}/verify-otp`, request).pipe(tap(response => {\n        if (response.accessToken) {\n          this.setSession(response);\n        }\n      }));\n    }\n    resetPassword(request) {\n      return this.http.post(`${this.apiUrl}/reset-password`, request);\n    }\n    getAllUsers() {\n      return this.http.get(`${this.apiUrl}/admin/users`);\n    }\n    updateUserRole(userId, role) {\n      return this.http.post(`${this.apiUrl}/admin/users/${userId}/role`, {\n        role\n      });\n    }\n    logout() {\n      localStorage.removeItem('accessToken');\n      localStorage.removeItem('refreshToken');\n      localStorage.removeItem('currentUser');\n      this.currentUserSubject.next(null);\n    }\n    isAuthenticated() {\n      const token = this.getToken();\n      return !!token && !this.isTokenExpired(token);\n    }\n    getToken() {\n      return localStorage.getItem('accessToken');\n    }\n    getCurrentUser() {\n      return this.currentUserSubject.value;\n    }\n    setSession(response) {\n      if (response.accessToken) {\n        localStorage.setItem('accessToken', response.accessToken);\n        // Extraire les infos utilisateur du JWT\n        try {\n          const payload = JSON.parse(atob(response.accessToken.split('.')[1]));\n          const user = {\n            id: payload.sub,\n            username: payload.username,\n            email: payload.email,\n            role: payload.role\n          };\n          localStorage.setItem('currentUser', JSON.stringify(user));\n          this.currentUserSubject.next(user);\n        } catch (e) {\n          console.error('Failed to decode JWT', e);\n        }\n      }\n      if (response.refreshToken) {\n        localStorage.setItem('refreshToken', response.refreshToken);\n      }\n      if (response.user) {\n        localStorage.setItem('currentUser', JSON.stringify(response.user));\n        this.currentUserSubject.next(response.user);\n      }\n    }\n    getUserFromStorage() {\n      const userStr = localStorage.getItem('currentUser');\n      return userStr ? JSON.parse(userStr) : null;\n    }\n    isTokenExpired(token) {\n      try {\n        const payload = JSON.parse(atob(token.split('.')[1]));\n        const expiry = payload.exp;\n        return Math.floor(new Date().getTime() / 1000) >= expiry;\n      } catch {\n        return true;\n      }\n    }\n    static ɵfac = function AuthService_Factory(t) {\n      return new (t || AuthService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.ConfigService));\n    };\n    static ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: AuthService,\n      factory: AuthService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n  return AuthService;\n})();","map":{"version":3,"names":["BehaviorSubject","tap","AuthService","http","config","apiUrl","currentUserSubject","currentUser$","asObservable","constructor","getAuthApiUrl","user","getUserFromStorage","next","register","request","post","login","credentials","pipe","response","accessToken","setSession","verifyOtp","sendResetOtp","verifyOtpAndResetPassword","resetPassword","getAllUsers","get","updateUserRole","userId","role","logout","localStorage","removeItem","isAuthenticated","token","getToken","isTokenExpired","getItem","getCurrentUser","value","setItem","payload","JSON","parse","atob","split","id","sub","username","email","stringify","e","console","error","refreshToken","userStr","expiry","exp","Math","floor","Date","getTime","i0","ɵɵinject","i1","HttpClient","i2","ConfigService","factory","ɵfac","providedIn"],"sources":["/home/sahar/Bureau/ERp/frontend/erp-ui/src/app/services/auth.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { BehaviorSubject, Observable, tap } from 'rxjs';\nimport { LoginRequest, LoginResponse, OtpRequest, ResetPasswordRequest, RegisterRequest, User } from '../models/user.model';\nimport { ConfigService } from './config.service';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class AuthService {\n  private apiUrl: string;\n  private currentUserSubject = new BehaviorSubject<User | null>(null);\n  public currentUser$ = this.currentUserSubject.asObservable();\n\n  constructor(\n    private http: HttpClient,\n    private config: ConfigService\n  ) {\n    this.apiUrl = this.config.getAuthApiUrl();\n    const user = this.getUserFromStorage();\n    if (user) {\n      this.currentUserSubject.next(user);\n    }\n  }\n\n  register(request: RegisterRequest): Observable<any> {\n    return this.http.post(`${this.apiUrl}/register`, request);\n  }\n\n  login(credentials: LoginRequest): Observable<LoginResponse> {\n    return this.http.post<LoginResponse>(`${this.apiUrl}/login`, credentials)\n      .pipe(\n        tap(response => {\n          if (response.accessToken) {\n            this.setSession(response);\n          }\n        })\n      );\n  }\n\n  verifyOtp(request: OtpRequest): Observable<LoginResponse> {\n    return this.http.post<LoginResponse>(`${this.apiUrl}/verify-otp`, request)\n      .pipe(\n        tap(response => {\n          if (response.accessToken && response.user) {\n            this.setSession(response);\n          }\n        })\n      );\n  }\n\n  sendResetOtp(request: { email: string }): Observable<any> {\n    return this.http.post(`${this.apiUrl}/reset-password`, request);\n  }\n\n  verifyOtpAndResetPassword(request: { email: string, code: string, newPassword: string }): Observable<LoginResponse> {\n    return this.http.post<LoginResponse>(`${this.apiUrl}/verify-otp`, request)\n      .pipe(\n        tap(response => {\n          if (response.accessToken) {\n            this.setSession(response);\n          }\n        })\n      );\n  }\n\n  resetPassword(request: ResetPasswordRequest): Observable<any> {\n    return this.http.post(`${this.apiUrl}/reset-password`, request);\n  }\n\n  getAllUsers(): Observable<any[]> {\n    return this.http.get<any[]>(`${this.apiUrl}/admin/users`);\n  }\n\n  updateUserRole(userId: string, role: string): Observable<any> {\n    return this.http.post(`${this.apiUrl}/admin/users/${userId}/role`, { role });\n  }\n\n  logout(): void {\n    localStorage.removeItem('accessToken');\n    localStorage.removeItem('refreshToken');\n    localStorage.removeItem('currentUser');\n    this.currentUserSubject.next(null);\n  }\n\n  isAuthenticated(): boolean {\n    const token = this.getToken();\n    return !!token && !this.isTokenExpired(token);\n  }\n\n  getToken(): string | null {\n    return localStorage.getItem('accessToken');\n  }\n\n  getCurrentUser(): User | null {\n    return this.currentUserSubject.value;\n  }\n\n  private setSession(response: LoginResponse): void {\n    if (response.accessToken) {\n      localStorage.setItem('accessToken', response.accessToken);\n      \n      // Extraire les infos utilisateur du JWT\n      try {\n        const payload = JSON.parse(atob(response.accessToken.split('.')[1]));\n        const user: User = {\n          id: payload.sub,\n          username: payload.username,\n          email: payload.email,\n          role: payload.role\n        };\n        localStorage.setItem('currentUser', JSON.stringify(user));\n        this.currentUserSubject.next(user);\n      } catch (e) {\n        console.error('Failed to decode JWT', e);\n      }\n    }\n    if (response.refreshToken) {\n      localStorage.setItem('refreshToken', response.refreshToken);\n    }\n    if (response.user) {\n      localStorage.setItem('currentUser', JSON.stringify(response.user));\n      this.currentUserSubject.next(response.user);\n    }\n  }\n\n  private getUserFromStorage(): User | null {\n    const userStr = localStorage.getItem('currentUser');\n    return userStr ? JSON.parse(userStr) : null;\n  }\n\n  private isTokenExpired(token: string): boolean {\n    try {\n      const payload = JSON.parse(atob(token.split('.')[1]));\n      const expiry = payload.exp;\n      return Math.floor(new Date().getTime() / 1000) >= expiry;\n    } catch {\n      return true;\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}